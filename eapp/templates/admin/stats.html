{% extends 'admin/master.html' %}

{% block body %}
<div class="container-fluid mt-4">
    <h2 class="text-center text-uppercase fw-bold mb-4 text-success">Thống kê & Báo cáo năm {{ year }}</h2>

    <div class="row mb-5">
        <div class="col-md-7">
            <div class="card shadow">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">Doanh Thu Theo Tháng</h5>
                </div>
                <div class="card-body">
                    <canvas id="revenueChart"></canvas>
                </div>
            </div>
        </div>

        <div class="col-md-5">
            <div class="card shadow">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0">Tỷ Lệ Học Viên Theo Khóa</h5>
                </div>
                <div class="card-body">
                    <canvas id="studentChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-12">
            <div class="card shadow">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">Tỷ lệ Đạt / Không Đạt Theo Khóa Học</h5>
                </div>
                <div class="card-body">
                    <canvas id="passFailChart" style="height: 400px;"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    function drawChart(ctx, type, labels, datasets) {
        new Chart(ctx, {
            type: type,
            data: {
                labels: labels,
                datasets: datasets
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });
    }

    window.onload = function() {
        let revLabels = [];
        let revData = [];
        {% for r in revenue_data %}
            revLabels.push("Tháng {{ r[0] }}");
            revData.push({{ r[1] }});
        {% endfor %}

        const ctx1 = document.getElementById('revenueChart');
        drawChart(ctx1, 'bar', revLabels, [{
            label: 'Doanh thu (VNĐ)',
            data: revData,
            backgroundColor: 'rgba(54, 162, 235, 0.7)',
            borderWidth: 1
        }]);

        let stuLabels = [];
        let stuData = [];
        {% for s in student_data %}
            stuLabels.push("{{ s[0] }}");
            stuData.push({{ s[1] }});
        {% endfor %}

        const ctx2 = document.getElementById('studentChart');
        drawChart(ctx2, 'pie', stuLabels, [{
            label: 'Số lượng học viên',
            data: stuData,
            backgroundColor: ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF']
        }]);

        let pfLabels = [];
        let passData = [];
        let failData = [];

        {% for pf in pass_fail_data %}
            pfLabels.push("{{ pf.course_name }}");
            passData.push({{ pf.pass }});
            failData.push({{ pf.fail }});
        {% endfor %}

        const ctx3 = document.getElementById('passFailChart');

        drawChart(ctx3, 'bar', pfLabels, [
            {
                label: 'Đạt',
                data: passData,
                backgroundColor: '#198754'
            },
            {
                label: 'Không Đạt',
                data: failData,
                backgroundColor: '#dc3545'
            }
        ]);
    }
</script>
{% endblock %}